<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sales Sniper V11</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#1e293b">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/1069/1069102.png">

    <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet" type="text/css" />
    <link rel="stylesheet" href="https://unpkg.com/persian-datepicker@1.2.0/dist/css/persian-datepicker.min.css"/>
    
    <style>
        :root { --bg-body: #f1f5f9; --bg-card: #ffffff; --header-bg: #1e293b; --header-text: #f8fafc; --primary: #2563eb; --accent: #f59e0b; --danger: #ef4444; --success: #10b981; --radius: 12px; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Vazirmatn', sans-serif; background-color: var(--bg-body); color: #334155; margin: 0; padding: 0; padding-bottom: 80px; }

        /* HEADER */
        .dashboard-header { background-color: var(--header-bg); color: var(--header-text); padding: 15px 20px 10px 20px; border-bottom-left-radius: 20px; border-bottom-right-radius: 20px; position: sticky; top: 0; z-index: 100; box-shadow: 0 4px 15px rgba(0,0,0,0.15); }
        .header-row { display: flex; justify-content: space-between; align-items: center; }
        .app-title { font-size: 1.1rem; font-weight: 900; }
        .live-clock { font-size: 1.4rem; font-weight: 700; color: var(--accent); direction: ltr; }
        
        /* INSTALL BANNER */
        #installBanner { display: none; background: var(--primary); color: white; padding: 10px; text-align: center; font-size: 0.9rem; cursor: pointer; margin-top: -5px; margin-bottom: 10px; border-radius: 8px; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.8; } 100% { opacity: 1; } }

        /* TABS & FORM */
        .tabs-container { display: flex; gap: 10px; margin-top: 15px; }
        .tab-btn { background: rgba(255,255,255,0.1); color: #ccc; border: 1px solid rgba(255,255,255,0.2); padding: 8px; border-radius: 8px; cursor: pointer; flex: 1; transition: 0.2s; font-family: inherit; }
        .tab-btn.active { background: var(--primary); color: white; border-color: var(--primary); font-weight: bold; }
        
        .container { max-width: 600px; margin: 0 auto; padding: 15px; }
        .card-input { background: var(--bg-card); padding: 15px; border-radius: var(--radius); box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .card-input.editing { border: 2px solid var(--accent); background: #fffbeb; }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .full-width { grid-column: span 2; }
        input, select { width: 100%; padding: 12px; border: 1px solid #cbd5e1; border-radius: 8px; font-family: inherit; background: #f8fafc; font-size: 16px; }
        
        .btn-add { background: var(--header-bg); color: white; border: none; padding: 12px; border-radius: 8px; font-weight: bold; width: 100%; margin-top: 10px; cursor: pointer; font-size: 1rem; }
        .btn-cancel { background: #94a3b8; color: white; border: none; padding: 8px; border-radius: 8px; width: 100%; margin-top: 5px; display: none; cursor: pointer; }

        /* TASKS */
        .task-card { background: var(--bg-card); padding: 12px; border-radius: var(--radius); margin-bottom: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); display: flex; justify-content: space-between; border-right: 4px solid #cbd5e1; position: relative; }
        .status-completed { opacity: 0.6; filter: grayscale(1); border-right-color: #cbd5e1 !important; }
        .status-completed .task-title { text-decoration: line-through; }
        .is-overdue:not(.status-completed) { border: 1px solid #fca5a5; background: #fef2f2; animation: flashRed 2s infinite; }
        @keyframes flashRed { 0% { border-color: #fca5a5; } 50% { border-color: var(--danger); } 100% { border-color: #fca5a5; } }
        
        .type-closing { border-right-color: var(--danger); }
        .type-followup { border-right-color: var(--accent); }
        .type-prospect { border-right-color: var(--primary); }

        .task-content { flex: 1; padding-left: 10px; }
        .task-title { font-weight: 700; margin: 0; }
        .task-meta { font-size: 0.8rem; color: #64748b; margin-top: 5px; display: flex; gap: 10px; align-items: center; }
        
        .action-group { display: flex; gap: 5px; align-items: center; }
        .icon-btn { width: 36px; height: 36px; border-radius: 8px; border: none; display: flex; align-items: center; justify-content: center; font-size: 1.1rem; cursor: pointer; }
        .btn-check { background: #dcfce7; color: var(--success); }
        .btn-edit { background: #fff7ed; color: var(--accent); }
        .btn-del { background: #fee2e2; color: var(--danger); }
        .hidden { display: none !important; }

        /* PERMISSIONS & IOS GUIDE */
        .perm-alert { background: var(--accent); color: #fff; padding: 10px; text-align: center; display: none; font-size: 0.9rem; cursor: pointer; }
        #iosInstallGuide { display: none; background: #fff; border: 1px solid #ddd; padding: 15px; border-radius: 12px; margin: 10px; text-align: center; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        #iosInstallGuide p { margin: 5px 0; font-size: 0.9rem; }
    </style>
</head>
<body data-mode="work">

<div id="permBar" class="perm-alert" onclick="requestPermissions()">
    âš ï¸ Ø¨Ø±Ø§ÛŒ ÙØ¹Ø§Ù„ Ø³Ø§Ø²ÛŒ Ø¢Ù„Ø§Ø±Ù… Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯
</div>

<div class="dashboard-header">
    <div class="header-row">
        <div>
            <div class="app-title">Sales Sniper V11</div>
            <div id="pipelineWrapper" style="font-size:0.8rem; margin-top:5px; opacity:0.8;">
                ğŸ’° <span id="pipelineValue">0</span>
            </div>
        </div>
        <div id="liveClock" class="live-clock">--:--</div>
    </div>

    <div id="installBanner" onclick="installPWA()">ğŸ“² Ù†ØµØ¨ Ø¨Ø±Ù†Ø§Ù…Ù‡ Ø±ÙˆÛŒ Ú¯ÙˆØ´ÛŒ</div>

    <div class="tabs-container">
        <button class="tab-btn active" data-target="work" onclick="switchTab('work')">Ú©Ø§Ø±</button>
        <button class="tab-btn" data-target="personal" onclick="switchTab('personal')">Ø´Ø®ØµÛŒ</button>
    </div>
</div>

<div id="iosInstallGuide">
    <p>ğŸ“² <strong>Ù†ØµØ¨ Ø¯Ø± Ø¢ÛŒÙÙˆÙ†:</strong></p>
    <p>Û±. Ø¯Ú©Ù…Ù‡ <strong>Share</strong> (Ù…Ø±Ø¨Ø¹ Ø¨Ø§ ÙÙ„Ø´ Ø¨Ø§Ù„Ø§) Ø±Ø§ Ø¨Ø²Ù†ÛŒØ¯.</p>
    <p>Û². Ú¯Ø²ÛŒÙ†Ù‡ <strong>Add to Home Screen</strong> Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯.</p>
    <button onclick="document.getElementById('iosInstallGuide').style.display='none'" style="margin-top:5px; padding:5px 15px;">Ø¨Ø§Ø´Ù‡</button>
</div>

<div class="container">
    <div class="card-input" id="inputBox">
        <div class="form-grid">
            <div class="full-width"><input type="text" id="inpTitle" placeholder="Ø¹Ù†ÙˆØ§Ù† Ú©Ø§Ø±..."></div>
            <div class="full-width">
                <input type="text" id="inpDate" class="pdate" placeholder="Ø²Ù…Ø§Ù† ÛŒØ§Ø¯Ø¢ÙˆØ±ÛŒ" readonly>
                <!-- ÙÛŒÙ„Ø¯ Ù…Ø®ÙÛŒ Ø¨Ø±Ø§ÛŒ Ø°Ø®ÛŒØ±Ù‡ Ø²Ù…Ø§Ù† Ø¯Ù‚ÛŒÙ‚ -->
                <input type="hidden" id="realTimestamp">
            </div>
            <input type="number" id="inpValue" class="work-field" placeholder="Ù…Ø¨Ù„Øº (ØªÙˆÙ…Ø§Ù†)">
            <select id="inpType" class="work-field">
                <option value="closing">Ù†Ù‡Ø§ÛŒÛŒ Ø³Ø§Ø²ÛŒ (Closing)</option>
                <option value="followup">Ù¾ÛŒÚ¯ÛŒØ±ÛŒ (Follow-up)</option>
                <option value="prospect">Ù…Ø´ØªØ±ÛŒ Ø¬Ø¯ÛŒØ¯</option>
            </select>
        </div>
        <button id="btnSubmit" class="btn-add" onclick="handleTaskSubmit()">Ø«Ø¨Øª ÙˆØ¸ÛŒÙÙ‡</button>
        <button id="btnCancel" class="btn-cancel" onclick="cancelEditMode()">Ù„ØºÙˆ</button>
    </div>

    <div id="taskList"></div>
</div>

<script src="https://unpkg.com/jquery@3.6.0/dist/jquery.min.js"></script>
<script src="https://unpkg.com/persian-date@1.1.0/dist/persian-date.min.js"></script>
<script src="https://unpkg.com/persian-datepicker@1.2.0/dist/js/persian-datepicker.min.js"></script>

<script>
    // --- ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø¯ÛŒØªØ§Ø¨ÛŒØ³ ---
    const DB_NAME = 'SalesSniper_V11'; 
    const DB_VERSION = 1; 
    let db, currentCategory = 'work', editModeId = null, pDatePicker;
    let deferredPrompt; 

    // --- Ø«Ø¨Øª Ø³Ø±ÙˆÛŒØ³ ÙˆØ±Ú©Ø± ---
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('sw.js')
                .then(reg => console.log('SW OK'))
                .catch(err => console.log('SW Fail', err));
        });
    }

    // --- Ù†ØµØ¨ PWA ---
    window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault(); deferredPrompt = e;
        document.getElementById('installBanner').style.display = 'block';
    });
    async function installPWA() {
        if (deferredPrompt) {
            deferredPrompt.prompt();
            const { outcome } = await deferredPrompt.userChoice;
            if (outcome === 'accepted') { deferredPrompt = null; document.getElementById('installBanner').style.display = 'none'; }
        }
    }

    function isIOS() {
        return [ 'iPad Simulator', 'iPhone Simulator', 'iPod Simulator', 'iPad', 'iPhone', 'iPod' ].includes(navigator.platform)
        || (navigator.userAgent.includes("Mac") && "ontouchend" in document);
    }
    if (isIOS() && !window.navigator.standalone) { document.getElementById('iosInstallGuide').style.display = 'block'; }

    // --- ØµØ¯Ø§ Ùˆ Ù…Ø¬ÙˆØ²Ù‡Ø§ ---
    const shortTick = new Audio("https://actions.google.com/sounds/v1/alarms/beep_short.ogg"); 

    function checkPermissionsOnLoad() {
        if ("Notification" in window && Notification.permission !== "granted") {
            document.getElementById('permBar').style.display = 'block';
        }
    }
    
    function requestPermissions() {
        Notification.requestPermission().then(permission => {
            if (permission === "granted") {
                document.getElementById('permBar').style.display = 'none';
                shortTick.play();
                new Notification("âœ… Ù…ØªØµÙ„ Ø´Ø¯", { body: "Ø¢Ù„Ø§Ø±Ù… Ù‡Ø§ ÙØ¹Ø§Ù„ Ø´Ø¯Ù†Ø¯." });
            }
        });
    }
    
    document.body.addEventListener('click', () => { shortTick.volume = 0.1; shortTick.play().catch(()=>{}); }, { once: true });

    setInterval(() => document.getElementById('liveClock').innerText = new Date().toLocaleTimeString('fa-IR', {hour:'2-digit', minute:'2-digit', hour12:false}), 1000);

    // --- Ø´Ø±ÙˆØ¹ Ø¨Ø±Ù†Ø§Ù…Ù‡ ---
    $(document).ready(function() {
        // ØªÙ†Ø¸ÛŒÙ… Ø¯ÛŒØª Ù¾ÛŒÚ©Ø±
        pDatePicker = $(".pdate").pDatepicker({
            format: 'YYYY/MM/DD HH:mm', timePicker: { enabled: true },
            initialValue: false, autoClose: true, altField: '#realTimestamp', altFormat: 'X'
        });
        checkPermissionsOnLoad();
        
        const request = indexedDB.open(DB_NAME, DB_VERSION);
        request.onupgradeneeded = (e) => {
            db = e.target.result;
            if (!db.objectStoreNames.contains("tasks")) {
                const store = db.createObjectStore("tasks", { keyPath: "id", autoIncrement: true });
                store.createIndex("category", "category", { unique: false });
            }
        };
        request.onsuccess = (e) => {
            db = e.target.result;
            loadTasks();
            setInterval(checkAlarms, 10000); // Ø¨Ø±Ø±Ø³ÛŒ Ù‡Ø± Û±Û° Ø«Ø§Ù†ÛŒÙ‡
        };
    });

    // --- ØªÙˆØ§Ø¨Ø¹ CRUD ---
    function switchTab(tabName) {
        cancelEditMode(); currentCategory = tabName;
        document.querySelectorAll('.tab-btn').forEach(t => t.classList.remove('active'));
        document.querySelector(`.tab-btn[data-target="${tabName}"]`).classList.add('active');
        const isPersonal = tabName === 'personal';
        document.querySelectorAll('.work-field').forEach(el => isPersonal ? el.classList.add('hidden') : el.classList.remove('hidden'));
        isPersonal ? document.getElementById('pipelineWrapper').classList.add('hidden') : document.getElementById('pipelineWrapper').classList.remove('hidden');
        loadTasks();
    }

    function handleTaskSubmit() {
        const title = document.getElementById('inpTitle').value;
        const rawTs = document.getElementById('realTimestamp').value; // Ù…Ù‚Ø¯Ø§Ø± Ø§ÛŒÙ† ÙÛŒÙ„Ø¯ Ø«Ø§Ù†ÛŒÙ‡ Ø§Ø³Øª
        
        if (!title.trim()) return alert("Ù„Ø·ÙØ§ Ø¹Ù†ÙˆØ§Ù† Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯");
        
        // Ø¨Ø§Ú¯ ÙÛŒÚ©Ø³: Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¬ÙˆØ¯ Ù…Ù‚Ø¯Ø§Ø± Ø¨Ø±Ø§ÛŒ ØªØ§Ø±ÛŒØ®
        let finalDueDate = null;
        if (rawTs && rawTs.trim() !== "") {
            finalDueDate = parseInt(rawTs) * 1000; // ØªØ¨Ø¯ÛŒÙ„ Ø¨Ù‡ Ù…ÛŒÙ„ÛŒ Ø«Ø§Ù†ÛŒÙ‡
        }

        const tx = db.transaction(["tasks"], "readwrite");
        const store = tx.objectStore("tasks");
        
        let taskData = {
            title, category: currentCategory,
            due_date: finalDueDate,
            status: 'active', updated_at: Date.now(),
            value: currentCategory === 'work' ? (parseInt(document.getElementById('inpValue').value) || 0) : 0,
            type: currentCategory === 'work' ? document.getElementById('inpType').value : 'personal'
        };

        if (editModeId) { taskData.id = editModeId; store.put(taskData); } 
        else { taskData.created_at = Date.now(); store.add(taskData); }
        tx.oncomplete = () => { cancelEditMode(); loadTasks(); };
    }

    function editTask(id) {
        db.transaction(["tasks"], "readonly").objectStore("tasks").get(id).onsuccess = (e) => {
            const task = e.target.result;
            document.getElementById('inpTitle').value = task.title;
            
            // Ø¨Ø§Ú¯ ÙÛŒÚ©Ø³: Ø³Øª Ú©Ø±Ø¯Ù† ØµØ­ÛŒØ­ ØªØ§Ø±ÛŒØ® Ø¯Ø± ÙˆÛŒØ±Ø§ÛŒØ´
            if(task.due_date) { 
                pDatePicker.setDate(task.due_date); 
                document.getElementById('realTimestamp').value = task.due_date/1000; 
            } else {
                pDatePicker.setDate(null);
                document.getElementById('realTimestamp').value = "";
            }

            if(task.category === 'work') { document.getElementById('inpValue').value = task.value; document.getElementById('inpType').value = task.type; }
            editModeId = id; document.getElementById('inputBox').classList.add('editing');
            document.getElementById('btnSubmit').innerText = "Ø°Ø®ÛŒØ±Ù‡ ØªØºÛŒÛŒØ±Ø§Øª"; document.getElementById('btnCancel').style.display = "block";
            window.scrollTo({ top: 0, behavior: 'smooth' });
        };
    }

    function cancelEditMode() {
        editModeId = null; 
        document.getElementById('inputBox').classList.remove('editing');
        document.getElementById('inpTitle').value = ''; 
        document.getElementById('inpValue').value = '';
        
        // Ø¨Ø§Ú¯ ÙÛŒÚ©Ø³: Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ Ú©Ø§Ù…Ù„ Ø¯ÛŒØª Ù¾ÛŒÚ©Ø±
        if(pDatePicker) pDatePicker.setDate(null);
        document.getElementById('realTimestamp').value = '';
        
        document.getElementById('btnSubmit').innerText = "Ø«Ø¨Øª ÙˆØ¸ÛŒÙÙ‡"; 
        document.getElementById('btnCancel').style.display = "none";
    }

    function toggleComplete(id) {
        const store = db.transaction(["tasks"], "readwrite").objectStore("tasks");
        store.get(id).onsuccess = (e) => {
            let task = e.target.result; task.status = (task.status === 'completed') ? 'active' : 'completed';
            store.put(task); loadTasks();
        };
    }

    function deleteTask(id) { 
        if(confirm("Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ")) { 
            db.transaction(["tasks"], "readwrite").objectStore("tasks").delete(id).onsuccess = loadTasks; 
            if(editModeId===id) cancelEditMode(); 
        } 
    }

    function loadTasks() {
        const listEl = document.getElementById('taskList'); listEl.innerHTML = '';
        let totalVal = 0;
        db.transaction(["tasks"], "readonly").objectStore("tasks").index("category").getAll(currentCategory).onsuccess = (e) => {
            let tasks = e.target.result.sort((a,b) => {
                if(a.status !== b.status) return a.status === 'completed' ? 1 : -1;
                if(a.due_date && b.due_date) return a.due_date - b.due_date;
                return a.due_date ? -1 : 1;
            });

            tasks.forEach(task => {
                if(task.category==='work' && task.status!=='completed') totalVal += (task.value||0);
                let isOverdue = task.status==='active' && task.due_date && task.due_date < Date.now();
                let dateStr = task.due_date ? new Date(task.due_date).toLocaleDateString('fa-IR',{month:'short',day:'numeric',hour:'2-digit',minute:'2-digit'}) : '';
                
                listEl.innerHTML += `
                    <div class="task-card type-${task.type} ${task.status==='completed'?'status-completed':''} ${isOverdue?'is-overdue':''}">
                        <div class="task-content">
                            <div class="task-title">${task.title}</div>
                            <div class="task-meta"><span>${isOverdue?'âš ï¸':(dateStr?'ğŸ“…':'')} ${dateStr}</span>${task.value?` | ğŸ’° ${Number(task.value).toLocaleString()}`:''}</div>
                        </div>
                        <div class="action-group">
                            <button class="icon-btn btn-check" onclick="toggleComplete(${task.id})">âœ”</button>
                            <button class="icon-btn btn-edit" onclick="editTask(${task.id})">âœ</button>
                            <button class="icon-btn btn-del" onclick="deleteTask(${task.id})">ğŸ—‘ï¸</button>
                        </div>
                    </div>`;
            });
            document.getElementById('pipelineValue').innerText = totalVal.toLocaleString('fa-IR');
        };
    }

    // --- Ø¢Ù„Ø§Ø±Ù… Ø¨Ù‡ÛŒÙ†Ù‡ Ø´Ø¯Ù‡ ---
    function checkAlarms() {
        let hasOverdue = false;
        let overdueCount = 0;

        db.transaction(["tasks"], "readonly").objectStore("tasks").openCursor().onsuccess = (e) => {
            const cursor = e.target.result;
            if (cursor) {
                const t = cursor.value;
                // Ø§Ú¯Ø± ØªØ³Ú© ÙØ¹Ø§Ù„ Ø§Ø³Øª Ùˆ Ø²Ù…Ø§Ù†Ø´ Ú¯Ø°Ø´ØªÙ‡
                if (t.status === 'active' && t.due_date && t.due_date <= Date.now()) {
                    hasOverdue = true;
                    overdueCount++;
                }
                cursor.continue();
            } else {
                // Ù¾Ø§ÛŒØ§Ù† Ø­Ù„Ù‚Ù‡ØŒ Ø­Ø§Ù„Ø§ ØªØµÙ…ÛŒÙ… Ù…ÛŒ Ú¯ÛŒØ±ÛŒÙ… ØµØ¯Ø§ Ù¾Ø®Ø´ Ú©Ù†ÛŒÙ… ÛŒØ§ Ø®ÛŒØ±
                // Ø¨Ø§Ú¯ ÙÛŒÚ©Ø³: ÙÙ‚Ø· ÛŒÚ© Ø¨Ø§Ø± ØµØ¯Ø§ Ù¾Ø®Ø´ Ù…ÛŒ Ø´ÙˆØ¯ØŒ Ù†Ù‡ Ø¨Ù‡ ØªØ¹Ø¯Ø§Ø¯ ØªØ³Ú© Ù‡Ø§
                if (hasOverdue) {
                    shortTick.volume = 1.0;
                    shortTick.play().catch(e => console.log("Audio blocked"));
                    
                    if (Notification.permission === "granted") {
                        new Notification("âš ï¸ ÙˆØ¸Ø§ÛŒÙ Ø¹Ù‚Ø¨ Ø§ÙØªØ§Ø¯Ù‡", { 
                            body: `Ø´Ù…Ø§ ${overdueCount} Ú©Ø§Ø± Ø§Ù†Ø¬Ø§Ù… Ù†Ø´Ø¯Ù‡ Ø¯Ø§Ø±ÛŒØ¯ Ú©Ù‡ Ø²Ù…Ø§Ù†Ø´Ø§Ù† Ú¯Ø°Ø´ØªÙ‡ Ø§Ø³Øª.`,
                            icon: 'https://cdn-icons-png.flaticon.com/512/1069/1069102.png',
                            tag: 'sales-alarm' // ØªÚ¯ ÛŒÚ©Ø³Ø§Ù† Ø¨Ø§Ø¹Ø« Ù…ÛŒ Ø´ÙˆØ¯ Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù† Ù‡Ø§ Ø±ÙˆÛŒ Ù‡Ù… Ø§Ø³Ù¾Ù… Ù†Ø´ÙˆÙ†Ø¯
                        });
                    }
                    loadTasks(); // Ø±ÙØ±Ø´ Ø¨Ø±Ø§ÛŒ Ù‚Ø±Ù…Ø² Ø´Ø¯Ù† Ú©Ø§Ø±Ù‡Ø§
                }
            }
        };
    }
</script>
</body>
</html>
